// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String        @id @default(uuid())
  email         String        @unique
  username      String        @unique
  password_hash String
  kyc_status    String        @default("pending") // pending, verified, rejected
  created_at    DateTime      @default(now())
  updated_at    DateTime      @updatedAt
  
  sessions      Session[]
  wallets       Wallet[]
  payments      Payment[]
  subscriptions Subscription[]
  devices       Device[]

  @@map("users")
}

model Session {
  id         String   @id @default(uuid())
  user_id    String
  device     String?
  ip_address String?
  token      String   @unique
  expires_at DateTime
  created_at DateTime @default(now())
  
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([token])
  @@map("sessions")
}

model Wallet {
  id             String        @id @default(uuid())
  user_id        String
  wallet_address String        @unique
  wallet_type    String        // pi, crypto, fiat
  balance        Float         @default(0)
  currency       String        @default("USD")
  is_active      Boolean       @default(true)
  created_at     DateTime      @default(now())
  updated_at     DateTime      @updatedAt
  
  user           User          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  transactions   Transaction[]

  @@index([user_id])
  @@index([wallet_address])
  @@map("wallets")
}

model Transaction {
  id          String   @id @default(uuid())
  wallet_id   String
  type        String   // credit, debit, transfer
  amount      Float
  currency    String   @default("USD")
  status      String   @default("pending") // pending, completed, failed
  description String?
  metadata    Json?
  created_at  DateTime @default(now())
  
  wallet      Wallet   @relation(fields: [wallet_id], references: [id], onDelete: Cascade)

  @@index([wallet_id])
  @@index([status])
  @@index([created_at])
  @@map("transactions")
}

model Payment {
  id             String   @id @default(uuid())
  user_id        String
  amount         Float
  currency       String   @default("USD")
  status         String   @default("pending") // pending, approved, completed, failed, cancelled
  payment_method String   // pi, card, wallet
  pi_payment_id  String?  @unique
  metadata       Json?
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt
  
  user           User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([status])
  @@index([pi_payment_id])
  @@map("payments")
}

model Plan {
  id            String         @id @default(uuid())
  name          String         @unique
  description   String?
  price         Float
  currency      String         @default("USD")
  duration_days Int
  features      Json?
  is_active     Boolean        @default(true)
  created_at    DateTime       @default(now())
  updated_at    DateTime       @updatedAt
  
  subscriptions Subscription[]

  @@map("plans")
}

model Subscription {
  id         String   @id @default(uuid())
  user_id    String
  plan_id    String
  status     String   @default("active") // active, cancelled, expired
  start_date DateTime @default(now())
  end_date   DateTime
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  plan       Plan     @relation(fields: [plan_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([plan_id])
  @@index([status])
  @@map("subscriptions")
}

model Device {
  id           String   @id @default(uuid())
  user_id      String
  device_name  String
  device_type  String   // mobile, desktop, tablet
  device_id    String   @unique
  push_token   String?
  is_active    Boolean  @default(true)
  last_used_at DateTime @default(now())
  created_at   DateTime @default(now())
  
  user         User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([device_id])
  @@map("devices")
}
